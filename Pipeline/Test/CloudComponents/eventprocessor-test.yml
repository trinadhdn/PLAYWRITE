steps:
  - task: DownloadPipelineArtifact@2
    displayName: 'Download environment artifact'
    inputs:
      artifact: 'environment'

  - powershell: |
      $filePath = Join-Path -Path $env:PIPELINE_WORKSPACE -ChildPath "environment.json"
      $json = Get-Content $filePath | Out-String | ConvertFrom-Json

      foreach($prop in $json.psobject.properties) {
        echo $prop.Name $prop.Value
        Write-Host("##vso[task.setvariable variable=$($prop.Name);isOutput=true]$($prop.Value)")
      }
    name: getBuildVariables
    displayName: 'Set build variables'

  - task: DownloadPipelineArtifact@2
    displayName: 'Download integration tests pipeline artifact'
    inputs:
      artifact: connmodule-integrationtests-$(getBuildVariables.artifactVersion)

  - task: ExtractFiles@1
    displayName: 'Extract pipeline artifacts'
    inputs:
      archiveFilePatterns: |
        $(Pipeline.Workspace)/connmodule-integrationtests-$(getBuildVariables.artifactVersion).zip
      cleanDestinationFolder: false

  - task: AzurePowerShell@5
    displayName: 'Run Tests'
    inputs:
      azureSubscription: ${{ parameters.service_conn }}
      ScriptType: 'InlineScript'
      Inline: |
        Import-Module ./toolintegrations/traceability/scripts/customjsongeneratorfunction_pester.psm1 -Force
        $env:environment = "$(targetEnvironment)" ;  $env:locationshortcut = "$(locationShortcut)" ;  $env:subsriptionprefix = "$(subscriptionPrefix)"
        $env:vmrgname = "$(testVmRg)"
        $pesterConfiguration = New-PesterConfiguration
        $pesterConfiguration.Run.Path = "integrationtests/Tests/CloudComponents/EventProcessor/getcloudlocationconfigs.Tests.ps1"
        $pesterConfiguration.Run.PassThru = $true
        $pesterConfiguration.TestResult.Enabled = $true
        $pesterConfiguration.TestResult.OutputFormat = "NUnitXml"
        $pesterConfiguration.TestResult.OutputPath = "$(System.DefaultWorkingDirectory)/test-event-cloudconfig.xml"
        $pesterConfiguration.Output.Verbosity = "Detailed"
        $resultConfigTests = Invoke-Pester -Configuration $pesterConfiguration
        $pesterConfiguration.Run.Path = "integrationtests/Tests/CloudComponents/EventProcessor/devicePropertiesExchange.Tests.ps1"
        $pesterConfiguration.TestResult.OutputPath = "$(System.DefaultWorkingDirectory)/test-event-deviceproperties.xml"
        $resultDevicePropTests = Invoke-Pester -Configuration $pesterConfiguration
        $pesterConfiguration.Run.Path = "integrationtests/Tests/CloudComponents/EventProcessor/telemetry.Tests.ps1"
        $pesterConfiguration.TestResult.OutputPath = "$(System.DefaultWorkingDirectory)/test-event-telemetry.xml"
        $resultTelemetryTests = Invoke-Pester -Configuration $pesterConfiguration         
        New-Item -ItemType Directory -Force -Path $(Pipeline.Workspace)/eventprocessorinttest
        customJson -results $resultConfigTests.Tests -outputFolderPath $(Pipeline.Workspace)/eventprocessorinttest -outputFileName "TESTS-eventprocessorconfig-integration-report.json"
        customJson -results $resultDevicePropTests.Tests -outputFolderPath $(Pipeline.Workspace)/eventprocessorinttest -outputFileName "TESTS-eventprocessordevprop-integration-report.json"
        customJson -results $resultTelemetryTests.Tests -outputFolderPath $(Pipeline.Workspace)/eventprocessorinttest -outputFileName "TESTS-eventprocessortelemetry-integration-report.json"
      azurePowerShellVersion: 'LatestVersion'

  - task: ArchiveFiles@2
    condition: |
      or (
           eq(variables['Build.SourceBranch'], 'refs/heads/main'),
           eq(variables['isCreateTestCasesInAdo'], 'true')
      )
    displayName: 'Create zip with generated test report json'
    inputs:
      rootFolderOrFile: '$(Pipeline.Workspace)/eventprocessorinttest'
      includeRootFolder: false
      archiveType: zip
      archiveFile: '$(Build.ArtifactStagingDirectory)/connmodule-eventprocessorinttestreports-$(regionSc)-$(getBuildVariables.artifactVersion).zip'
      replaceExistingArchive: true

  - task: PublishPipelineArtifact@1
    condition: |
      or (
          eq(variables['Build.SourceBranch'], 'refs/heads/main'),
          eq(variables['isCreateTestCasesInAdo'], 'true')
      )
    displayName: 'Publish Pipeline artifact'
    inputs:
      path: '$(Build.ArtifactStagingDirectory)'
      artifact: 'connmodule-eventprocessorinttestreports-$(regionSc)-$(getBuildVariables.artifactVersion)'

  - task: PublishTestResults@2
    displayName: 'Publish Results'
    inputs:
      testResultsFormat: 'NUnit'
      testResultsFiles: '**/test-event*.xml'
      failTaskOnFailedTests: true
      testRunTitle: 'Connectivity Module-Event Processor-$(Build.SourceBranchName)-$(regionSc)-Integration Tests'
